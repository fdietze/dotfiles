#!/usr/bin/env bash
set -eu

STATE_FILE="/tmp/dictate.state"

# If a state file exists, check if the process is actually running.
if [ -f "$STATE_FILE" ]; then
    PID=$(head -n 1 "$STATE_FILE")
    # If kill -0 succeeds, a process with that PID exists.
    if kill -0 "$PID" 2>/dev/null; then
        # A recording is already active, so do nothing.
        exit 0
    else
        # The state file is stale (from a crash). Clean up before proceeding.
        WAV_FILE=$(tail -n 1 "$STATE_FILE")
        rm -f "$STATE_FILE" "$WAV_FILE"
    fi
fi

# Create a new temporary file for the recording.
WAV_FILE=$(mktemp /tmp/dictate-XXXXXX.wav)

# Start recording in the background.
arecord --quiet -f S16_LE -r 16000 -t wav "$WAV_FILE" &
REC_PID=$!

# Store the PID and the temporary file path for the stop script to find.
echo "$REC_PID" > "$STATE_FILE"
echo "$WAV_FILE" >> "$STATE_FILE"