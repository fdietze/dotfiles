#!/usr/bin/env bash
set -eu

STATE_FILE="/tmp/dictate.state"

# If there is no state file, there is no recording to stop.
if [ ! -f "$STATE_FILE" ]; then
  exit 0
fi

# Read the PID and WAV file path from the state file.
PID=$(head -n 1 "$STATE_FILE")
WAV_FILE=$(tail -n 1 "$STATE_FILE")

# Stop the recording process. The "|| true" prevents the script from exiting
# if the process has already died for some reason.
kill "$PID" 2>/dev/null || true
wait "$PID" 2>/dev/null || true

# Transcribe and type the result, if the audio file exists.
if [ -f "$WAV_FILE" ]; then
  xdotool key --clearmodifiers shift
  xdotool type "$(whisper-cli -t 8 -l auto --no-prints --no-timestamps --model ~/downloads/ggml-small-q8_0.bin --output-txt - <"$WAV_FILE")"
fi

# Clean up the temporary files.
rm -f "$STATE_FILE" "$WAV_FILE"
